<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>GREY CITY: OVERSEER SYSTEM</title>
    <style>
        :root { 
            --bg: #050505; 
            --panel: #111; 
            --border: #333; 
            --neon-red: #ff2a2a; 
            --neon-cyan: #00e5ff; 
            --neon-purple: #bd00ff;
        }
        
        body { 
            background: var(--bg); 
            color: #ccc; 
            font-family: 'Courier New', monospace; 
            margin: 0; 
            padding: 20px; 
            display: flex; 
            height: 100vh; 
            box-sizing: border-box; 
            overflow: hidden;
            background-image: radial-gradient(circle at 50% 50%, #1a1a1a 0%, #000 100%);
        }

        /* CRT ëª¨ë‹ˆí„° ìŠ¤ìº”ë¼ì¸ íš¨ê³¼ */
        body::after {
            content: "";
            position: absolute;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background: repeating-linear-gradient(0deg, rgba(0,0,0,0.1), rgba(0,0,0,0.1) 1px, transparent 1px, transparent 2px);
            pointer-events: none;
            z-index: 999;
        }
        
        .header-container {
            position: absolute;
            top: 20px; left: 20px;
            display: flex;
            flex-direction: column;
            z-index: 10;
        }

        .header { 
            font-size: 22px; 
            color: var(--neon-red); 
            font-weight: bold; 
            letter-spacing: 2px;
            text-shadow: 0 0 10px rgba(255,42,42,0.5); 
        }
        
        .sub-header {
            font-size: 10px;
            color: #666;
            margin-top: 5px;
            letter-spacing: 1px;
        }

        .back-btn { 
            position: absolute; 
            top: 20px; right: 20px; 
            background: rgba(255,255,255,0.05); 
            border: 1px solid #444; 
            color: #aaa; 
            padding: 8px 20px; 
            cursor: pointer; 
            font-family: inherit;
            font-weight: bold;
            transition: 0.3s;
            z-index: 10;
        }
        .back-btn:hover { background: #fff; color: #000; box-shadow: 0 0 10px rgba(255,255,255,0.5); }
        
        .dashboard { 
            display: flex; 
            width: 100%; 
            margin-top: 50px; 
            gap: 20px; 
            height: calc(100% - 50px); 
            z-index: 5;
        }
        
        /* ì™¼ìª½ ìœ ì € ë¦¬ìŠ¤íŠ¸ íŒ¨ë„ */
        .list-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--panel); 
            border: 1px solid var(--border); 
            box-shadow: 0 0 15px rgba(0,0,0,0.8);
        }

        .search-container {
            padding: 15px;
            border-bottom: 1px solid var(--border);
            background: #0a0a0a;
        }

        .search-box {
            width: 100%;
            background: #000;
            border: 1px solid #444;
            color: var(--neon-cyan);
            padding: 10px;
            font-family: inherit;
            box-sizing: border-box;
            outline: none;
            transition: 0.3s;
        }
        .search-box:focus {
            border-color: var(--neon-cyan);
            box-shadow: inset 0 0 5px rgba(0, 229, 255, 0.2);
        }
        .search-box::placeholder {
            color: #555;
        }

        .list-info {
            font-size: 11px;
            color: #666;
            margin-top: 8px;
            text-align: right;
        }

        .user-list { 
            flex: 1; 
            overflow-y: auto; 
            padding: 10px; 
        }
        
        /* ìŠ¤í¬ë¡¤ë°” ë””ìì¸ */
        .user-list::-webkit-scrollbar, textarea::-webkit-scrollbar { width: 6px; }
        .user-list::-webkit-scrollbar-track, textarea::-webkit-scrollbar-track { background: #0a0a0a; }
        .user-list::-webkit-scrollbar-thumb, textarea::-webkit-scrollbar-thumb { background: #333; }
        .user-list::-webkit-scrollbar-thumb:hover, textarea::-webkit-scrollbar-thumb:hover { background: var(--neon-cyan); }

        .user-item { 
            padding: 12px; 
            border: 1px solid #222; 
            background: #0d0d0d;
            margin-bottom: 8px;
            cursor: pointer; 
            transition: 0.2s; 
            border-radius: 4px;
        }
        .user-item:hover { 
            background: rgba(0,229,255,0.05); 
            border-color: #008899; 
        }
        .user-item.active { 
            background: rgba(255,42,42,0.05); 
            border-color: var(--neon-red);
            box-shadow: inset 0 0 10px rgba(255,42,42,0.1);
        }

        .user-item-name { color: #fff; font-weight: bold; font-size: 14px; margin-bottom: 4px; display: flex; justify-content: space-between; }
        .user-item-email { font-size: 11px; color: var(--neon-purple); margin-bottom: 6px; word-break: break-all; }
        .user-item-stats { font-size: 11px; color: #888; }
        
        /* ì˜¤ë¥¸ìª½ ë°ì´í„° ì—ë””í„° íŒ¨ë„ */
        .editor-panel { 
            flex: 2; 
            display: flex; 
            flex-direction: column; 
            background: var(--panel); 
            border: 1px solid var(--border); 
            padding: 20px; 
            box-shadow: 0 0 15px rgba(0,0,0,0.8);
        }
        
        .editor-header { 
            display: flex; 
            justify-content: space-between; 
            margin-bottom: 15px; 
            align-items: flex-end; 
            border-bottom: 1px dashed var(--border);
            padding-bottom: 10px;
        }
        #editorTitle { font-size: 16px; color: #fff; font-weight: bold; letter-spacing: 1px; }
        
        textarea { 
            flex: 1; 
            background: #050505; 
            color: #00e5ff; 
            border: 1px solid #333; 
            font-family: inherit; 
            font-size: 13px;
            padding: 15px; 
            resize: none; 
            outline: none; 
            border-radius: 4px;
            line-height: 1.5;
        }
        textarea:focus { border-color: #555; }
        textarea:disabled { color: #555; }
        
        .btn-group { margin-top: 15px; display: flex; gap: 15px; }
        button { padding: 12px; font-weight: bold; cursor: pointer; font-family: inherit; border-radius: 4px; letter-spacing: 1px; transition: 0.2s; }
        button:disabled { opacity: 0.3; cursor: not-allowed !important; }
        
        .btn-save { flex: 2; background: rgba(0,229,255,0.05); border: 1px solid var(--neon-cyan); color: var(--neon-cyan); }
        .btn-save:hover:not(:disabled) { background: var(--neon-cyan); color: #000; box-shadow: 0 0 15px var(--neon-cyan); }
        
        .btn-delete { flex: 1; background: rgba(255,42,42,0.05); border: 1px solid var(--neon-red); color: var(--neon-red); }
        .btn-delete:hover:not(:disabled) { background: var(--neon-red); color: #000; box-shadow: 0 0 15px var(--neon-red); }
    </style>
</head>
<body>

    <div class="header-container">
        <div class="header">SYS-ADMIN OVERSEER</div>
        <div class="sub-header">SECURITY LEVEL: OMEGA | AUTHORIZED ACCESS ONLY</div>
    </div>
    
    <button class="back-btn" onclick="location.href='/'">RETURN TO GAME</button>

    <div class="dashboard">
        <div class="list-panel">
            <div class="search-container">
                <input type="text" id="searchInput" class="search-box" placeholder="Search ID, Name, Email..." autocomplete="off">
                <div class="list-info" id="userCountInfo">Loading users...</div>
            </div>
            <div class="user-list" id="userList">
                <div style="text-align:center; margin-top:30px; color:#555;">SYSTEM INITIATING...</div>
            </div>
        </div>
        
        <div class="editor-panel">
            <div class="editor-header">
                <span id="editorTitle">ëŒ€ìƒì„ ì„ íƒí•˜ì‹­ì‹œì˜¤.</span>
                <span id="statusMsg" style="font-size:12px; color:var(--neon-cyan);">WAITING...</span>
            </div>
            <textarea id="jsonEditor" disabled spellcheck="false" placeholder="ë°ì´í„°ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤..."></textarea>
            <div class="btn-group">
                <button class="btn-save" id="btnSave" disabled onclick="saveUserData()">[ ğŸ’¾ FORCE OVERWRITE ]</button>
                <button class="btn-delete" id="btnDelete" disabled onclick="deleteUser()">[ â˜ ï¸ PURGE USER ]</button>
            </div>
        </div>
    </div>

    <script>
        let allUsers = {};
        let currentUserId = null;

        // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
        async function fetchUsers() {
            try {
                const res = await fetch('/api/admin/users');
                allUsers = await res.json();
                renderUserList();
            } catch(e) { 
                console.error(e); 
                document.getElementById('userCountInfo').innerText = "Database connection failed.";
            }
        }

        // ìœ ì € ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ (ê²€ìƒ‰ í•„í„° ì ìš©)
        function renderUserList(filterText = '') {
            const list = document.getElementById('userList');
            list.innerHTML = '';
            
            const lowerFilter = filterText.toLowerCase();
            let count = 0;

            for (const [userId, data] of Object.entries(allUsers)) {
                const username = (data.username || 'Unknown').toLowerCase();
                const email = (data.email || 'No Email Registered').toLowerCase();
                const uid = userId.toLowerCase();

                // ê²€ìƒ‰ ì¡°ê±´ (ID, ë‹‰ë„¤ì„, ì´ë©”ì¼ ì¤‘ í•˜ë‚˜ë¼ë„ í¬í•¨ë˜ë©´ ë Œë”ë§)
                if (username.includes(lowerFilter) || email.includes(lowerFilter) || uid.includes(lowerFilter)) {
                    count++;
                    const div = document.createElement('div');
                    div.className = 'user-item';
                    if (userId === currentUserId) div.classList.add('active');

                    div.innerHTML = `
                        <div class="user-item-name">
                            <span>${data.username || 'Unknown'}</span>
                            <span style="font-size:10px; color:#555;">Lv.${data.level || 1}</span>
                        </div>
                        <div class="user-item-email">âœ‰ï¸ ${data.email || 'No Email'}</div>
                        <div class="user-item-stats">
                            ID: ${userId} <br>
                            HP: <span style="color:var(--neon-red)">${data.hp || 0}</span> / ${data.maxHp || 0} | ğŸ«€: ${data.heart_fragments || 0}
                        </div>
                    `;
                    div.onclick = () => selectUser(userId, div);
                    list.appendChild(div);
                }
            }

            document.getElementById('userCountInfo').innerText = `TOTAL: ${count} USERS FOUND`;
            
            if (count === 0) {
                list.innerHTML = `<div style="text-align:center; margin-top:30px; color:#555;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
            }
        }

        // ê²€ìƒ‰ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.getElementById('searchInput').addEventListener('input', (e) => {
            renderUserList(e.target.value);
        });

        // ìœ ì € ì„ íƒ
        function selectUser(userId, el) {
            document.querySelectorAll('.user-item').forEach(d => d.classList.remove('active'));
            el.classList.add('active');
            
            currentUserId = userId;
            document.getElementById('editorTitle').innerText = `TARGET : ${allUsers[userId].username}`;
            
            // JSON í¬ë§·íŒ… (ë“¤ì—¬ì“°ê¸° 4ì¹¸)
            const editor = document.getElementById('jsonEditor');
            editor.value = JSON.stringify(allUsers[userId], null, 4);
            editor.disabled = false;
            
            document.getElementById('btnSave').disabled = false;
            document.getElementById('btnDelete').disabled = false;
            document.getElementById('statusMsg').innerText = "READY TO MODIFY";
            document.getElementById('statusMsg').style.color = "var(--neon-cyan)";
        }

        // ë°ì´í„° ì €ì¥ (ë®ì–´ì“°ê¸°)
        async function saveUserData() {
            if(!currentUserId) return;
            try {
                const newData = JSON.parse(document.getElementById('jsonEditor').value);
                
                document.getElementById('statusMsg').innerText = "UPDATING...";
                document.getElementById('statusMsg').style.color = "#fff";

                const res = await fetch(`/api/admin/user/${currentUserId}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(newData)
                });
                const result = await res.json();
                
                if(result.success) {
                    document.getElementById('statusMsg').innerText = "UPDATE SUCCESSFUL!";
                    document.getElementById('statusMsg').style.color = "var(--neon-cyan)";
                    allUsers[currentUserId] = newData; // ë¡œì»¬ ìºì‹œ ì—…ë°ì´íŠ¸
                    renderUserList(document.getElementById('searchInput').value); // í˜„ì¬ ê²€ìƒ‰ì–´ ìœ ì§€í•˜ë©° ë¦¬ìŠ¤íŠ¸ ê°±ì‹ 
                }
            } catch(e) {
                document.getElementById('statusMsg').innerText = "JSON FORMAT ERROR";
                document.getElementById('statusMsg').style.color = "var(--neon-red)";
                alert("JSON í˜•ì‹ì´ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤. ì‰¼í‘œ(,)ë‚˜ ê´„í˜¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.");
            }
        }

        // ìœ ì € ì‚­ì œ (ë°´)
        async function deleteUser() {
            if(!currentUserId) return;
            if(confirm("âš ï¸ ê²½ê³ : ì´ ìœ ì €ë¥¼ ì‹œìŠ¤í…œì—ì„œ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ì¦‰ì‹œ ì‹¤í–‰ë˜ë©° ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")) {
                
                document.getElementById('statusMsg').innerText = "PURGING USER...";
                document.getElementById('statusMsg').style.color = "var(--neon-red)";

                const res = await fetch(`/api/admin/user/${currentUserId}`, { method: 'DELETE' });
                const result = await res.json();
                
                if(result.success) {
                    alert("ëŒ€ìƒì´ ì‹œìŠ¤í…œì—ì„œ ì˜êµ¬ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    document.getElementById('jsonEditor').value = '';
                    document.getElementById('jsonEditor').disabled = true;
                    document.getElementById('btnSave').disabled = true;
                    document.getElementById('btnDelete').disabled = true;
                    document.getElementById('editorTitle').innerText = 'ëŒ€ìƒì„ ì„ íƒí•˜ì‹­ì‹œì˜¤.';
                    document.getElementById('statusMsg').innerText = "WAITING...";
                    currentUserId = null;
                    
                    fetchUsers(); // DB ìƒˆë¡œê³ ì¹¨
                } else {
                    document.getElementById('statusMsg').innerText = "PURGE FAILED";
                }
            }
        }

        // ì‹œì‘ ì‹œ ë°ì´í„° ë¡œë“œ
        fetchUsers();
    </script>
</body>
</html>