<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GREY CITY: ACCESS</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="anim-wrapper">
        <div class="loginContainer">
            
            <div class="corner tl"></div>
            <div class="corner tr"></div>
            <div class="corner bl"></div>
            <div class="corner br"></div>

            <div class="content-wrapper">
                <div class="header">
                    <h1>GREY CITY</h1>
                    <div style="font-size: 10px; color: #666; margin-top: 5px;">ACCESS TERMINAL v2.0</div>
                </div>

                <div class="content">
                    <div class="tabs">
                        <button class="tab active" onclick="switchTab('login')">LOGIN</button>
                        <button class="tab" onclick="switchTab('register')">REGISTER</button>
                    </div>

                    <div class="form-slider">
                        <div class="form-slider-track" id="formTrack">
                            
                            <div id="loginForm" class="form-slide">
                                <input type="text" id="l_id" placeholder="SURVIVAL ID" autocomplete="off">
                                <input type="password" id="l_pw" placeholder="SURVIVAL PASSWORD" autocomplete="off">
                                <button class="btn" onclick="localLogin()">SYSTEM ACCESS</button>
                            </div>

                            <div id="registerForm" class="form-slide">
                                <input type="text" id="r_id" placeholder="NEW ID" autocomplete="off">
                                <input type="password" id="r_pw" placeholder="NEW PASSWORD" autocomplete="off">
                                
                                <div style="margin-top: 15px; padding-top: 12px; border-top: 1px dashed #333;">
                                    <div class="security-badge">üîí SECURITY VERIFICATION</div>
                                    <div class="email-group">
                                        <input type="email" id="r_email" placeholder="YOUR EMAIL" autocomplete="off">
                                        <button class="btn btn-code" id="btnSendCode" onclick="sendVerificationCode()">[ SEND ]</button>
                                    </div>
                                    
                                    <div id="codeWrapper" style="display: none; margin-bottom: 10px;">
                                        <input type="text" id="r_code" class="code-input" placeholder="CODE" autocomplete="off" maxlength="6">
                                    </div>
                                </div>
                                
                                <button class="btn" style="border-color:var(--neon-purple); color:var(--neon-purple)" onclick="localRegister()">REGISTRATION</button>
                            </div>

                        </div>
                    </div>

                    <div id="statusMsg" class="msg"></div>

                    <div class="divider">OR EXTERNAL LINK</div>

                    <button class="btn discord-btn" onclick="location.href='/login/discord'">
                        Access via Discord
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function switchTab(mode) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById('statusMsg').innerText = '';
            
            const track = document.getElementById('formTrack');
            
            if (mode === 'login') {
                document.querySelector('.tab:nth-child(1)').classList.add('active');
                track.style.transform = 'translateX(0)';
            } else {
                document.querySelector('.tab:nth-child(2)').classList.add('active');
                track.style.transform = 'translateX(-50%)';
            }
        }

        async function localLogin() {
            const id = document.getElementById('l_id').value;
            const pw = document.getElementById('l_pw').value;
            const msgEl = document.getElementById('statusMsg');

            if (!id || !pw) {
                msgEl.innerText = "IDÏôÄ ÏïîÌò∏Î•º ÏûÖÎ†•ÌïòÏã≠ÏãúÏò§.";
                msgEl.className = "msg error";
                return;
            }

            try {
                const res = await fetch('/api/login_local', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({username: id, password: pw})
                });
                const data = await res.json();

                if (data.success) {
                    msgEl.innerText = "Ï†ëÏÜç ÏäπÏù∏. ÏãúÏä§ÌÖú Ïó∞Í≤∞ Ï§ë...";
                    msgEl.className = "msg success";
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    msgEl.innerText = "Ïò§Î•ò: " + data.msg;
                    msgEl.className = "msg error";
                }
            } catch (e) {
                console.error(e);
                msgEl.innerText = "ÎÑ§Ìä∏ÏõåÌÅ¨ ÌÜµÏã† Ïò§Î•ò.";
                msgEl.className = "msg error";
            }
        }

        async function sendVerificationCode() {
            const email = document.getElementById('r_email').value.trim();
            const msgEl = document.getElementById('statusMsg');
            const btnSend = document.getElementById('btnSendCode');

            if (!email) {
                msgEl.innerText = "Ïù¥Î©îÏùº Ï£ºÏÜåÎ•º ÏûÖÎ†•ÌïòÏã≠ÏãúÏò§.";
                msgEl.className = "msg error";
                return;
            }

            // Ï†ÑÏÜ° Ï§ë UI Î∞òÏùë
            msgEl.innerText = "Î≥¥Ïïà ÏÑúÎ≤ÑÏôÄ ÌÜµÏã† Ï§ë... (ÏΩîÎìú Î∞úÏÜ°)";
            msgEl.className = "msg";
            btnSend.innerText = "[ WAITING ]";
            btnSend.style.pointerEvents = "none";

            try {
                const res = await fetch('/api/send_code', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({email: email})
                });
                const data = await res.json();

                btnSend.innerText = "[ RESEND ]";
                btnSend.style.pointerEvents = "auto";

                if (data.success) {
                    msgEl.innerText = data.msg;
                    msgEl.className = "msg success";
                    
                    // ÏûÖÎ†•Ï∞ΩÏù¥ ÏóÜÏóàÎã§Î©¥ ÌéòÏù¥ÎìúÎã§Ïö¥ Ïï†ÎãàÎ©îÏù¥ÏÖòÍ≥º Ìï®Íªò Î†åÎçîÎßÅ
                    const codeWrapper = document.getElementById('codeWrapper');
                    if(codeWrapper.style.display === 'none') {
                        codeWrapper.style.display = 'block';
                        codeWrapper.classList.add('fade-in-down');
                    }
                } else {
                    msgEl.innerText = data.msg;
                    msgEl.className = "msg error";
                }
            } catch (e) {
                btnSend.innerText = "[ SEND ]";
                btnSend.style.pointerEvents = "auto";
                msgEl.innerText = "ÎÑ§Ìä∏ÏõåÌÅ¨ ÌÜµÏã† Ïò§Î•ò.";
                msgEl.className = "msg error";
            }
        }

        async function localRegister() {
            const id = document.getElementById('r_id').value.trim();
            const pw = document.getElementById('r_pw').value.trim();
            const email = document.getElementById('r_email').value.trim();
            const code = document.getElementById('r_code').value.trim();
            const msgEl = document.getElementById('statusMsg');
            const codeWrapper = document.getElementById('codeWrapper');

            if (!id || !pw || !email) {
                msgEl.innerText = "Î™®Îì† Îì±Î°ù Ï†ïÎ≥¥Î•º ÏûÖÎ†•ÌïòÏã≠ÏãúÏò§.";
                msgEl.className = "msg error";
                return;
            }

            if (codeWrapper.style.display === 'block' && !code) {
                msgEl.innerText = "ÏàòÏã†Îêú Î≥¥Ïïà ÏΩîÎìúÎ•º Ï†ïÌôïÌûà ÏûÖÎ†•ÌïòÏã≠ÏãúÏò§.";
                msgEl.className = "msg error";
                return;
            }

            try {
                const res = await fetch('/api/register', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({username: id, password: pw, email: email, code: code})
                });
                const data = await res.json();

                if (data.success) {
                    msgEl.innerText = "Îì±Î°ù ÏôÑÎ£å. ÏãúÏä§ÌÖú Ï†ëÍ∑ºÏùÑ ÏäπÏù∏Ìï©ÎãàÎã§.";
                    msgEl.className = "msg success";
                    
                    // Ìèº Ï¥àÍ∏∞Ìôî
                    document.getElementById('r_id').value = '';
                    document.getElementById('r_pw').value = '';
                    document.getElementById('r_email').value = '';
                    document.getElementById('r_code').value = '';
                    codeWrapper.style.display = 'none';
                    codeWrapper.classList.remove('fade-in-down');
                    document.getElementById('btnSendCode').innerText = "[ SEND ]";
                    
                    // ÏÑ±Í≥µ ÌõÑ ÏûêÎèôÏúºÎ°ú Î°úÍ∑∏Ïù∏ ÌÉ≠ÏúºÎ°ú Ïä§Î•¥Î•µ Ï†ÑÌôò
                    setTimeout(() => switchTab('login'), 1500);
                } else {
                    msgEl.innerText = "Îì±Î°ù Í±∞Î∂ÄÎê®: " + data.msg;
                    msgEl.className = "msg error";
                }
            } catch (e) {
                console.error(e);
                msgEl.innerText = "ÎÑ§Ìä∏ÏõåÌÅ¨ ÌÜµÏã† Ïò§Î•ò.";
                msgEl.className = "msg error";
            }
        }

        // ÏóîÌÑ∞ÌÇ§ ÏßÄÏõê
        document.getElementById('l_pw').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') localLogin();
        });
        document.getElementById('r_pw').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') localRegister();
        });
        document.getElementById('r_code').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') localRegister();
        });
    </script>
</body>
</html>